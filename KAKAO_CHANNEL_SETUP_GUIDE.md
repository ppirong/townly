# 🚨 카카오 채널 챗봇 연동 완전 가이드

## 현재 문제 상황
- ✅ 웹훅 URL 정상 작동: https://2da26f20f041.ngrok-free.app/api/kakao/webhook
- ❌ 카카오 앱에서 채널에 메시지를 보내도 챗봇이 응답하지 않음
- ❌ 메시지만 채널에 저장되고 챗봇 반응 없음

## ⚠️ 중요: 스킬 URL만 설정해서는 작동하지 않습니다!

**카카오 채널에서 챗봇이 응답하려면 다음 4단계가 모두 완료되어야 합니다:**

### 1단계: 카카오 i 오픈빌더 설정

#### A. 봇 생성 및 활성화
1. **카카오 i 오픈빌더** (https://i.kakao.com/) 접속
2. **"townly" 봇**이 **"활성화"** 상태인지 확인
3. 비활성화되어 있다면 반드시 활성화

#### B. 스킬 등록 (현재 완료된 상태)
1. **"스킬"** 메뉴 → **"스킬 생성"**
2. **스킬 URL**: `https://2da26f20f041.ngrok-free.app/api/kakao/webhook`
3. **스킬 활성화** 확인

#### C. 시나리오 설정 (가장 중요!)
1. **"시나리오"** 메뉴 클릭
2. **"Welcome 블록"** 또는 **"기본 블록"** 설정
3. **폴백 블록**을 다음과 같이 설정:
   ```
   사용자 발화 → 스킬 호출 → 웹훅 URL로 전달
   ```
4. **모든 사용자 입력**이 스킬로 전달되도록 설정

### 2단계: 카카오톡 채널 관리자센터 설정

#### A. 채널 기본 설정
1. **카카오톡 채널 관리자센터** (https://center-pf.kakao.com/) 접속
2. **"Townly" 채널** 선택
3. 채널이 **"공개"** 상태인지 확인

#### B. 챗봇 연결 설정 (핵심!)
1. **"관리 > 채팅"** 메뉴
2. **"챗봇 연결"** 버튼 클릭
3. **"townly" 봇** 선택하여 연결
4. **자동응답 설정**을 **"챗봇 우선"** 또는 **"챗봇 전용"**으로 변경

### 3단계: 카카오 i 오픈빌더에서 채널 연결

#### A. 채널 연결
1. **카카오 i 오픈빌더**에서 **"채널 연결"** 메뉴
2. **"채널 추가"** 클릭
3. **"Townly" 채널** 검색 및 연결
4. 연결 상태가 **"정상"**인지 확인

### 4단계: 최종 설정 확인

#### A. 시나리오 플로우 확인
```
사용자 메시지 입력
    ↓
카카오톡 채널 수신
    ↓
카카오 i 오픈빌더로 전달
    ↓
시나리오 실행 (폴백 블록)
    ↓
스킬 호출 (웹훅 URL)
    ↓
localhost:3000 서버 처리
    ↓
응답 생성 및 전송
    ↓
카카오톡 채널로 응답 표시
```

## 🔧 즉시 확인해야 할 설정들

### 우선순위 1: 자동응답 설정 확인
**카카오톡 채널 관리자센터에서:**
- **"관리 > 채팅"** → **"자동응답 설정"**
- **현재 설정**이 **"관리자 우선"**이면 **"챗봇 우선"**으로 변경

### 우선순위 2: 봇 활성화 상태 확인
**카카오 i 오픈빌더에서:**
- **봇 목록**에서 **"townly"** 봇의 상태 확인
- **"비활성화"**면 **"활성화"**로 변경

### 우선순위 3: 채널 연결 상태 확인
**카카오 i 오픈빌더에서:**
- **"채널 연결"** 메뉴에서 **"Townly"** 채널이 연결되어 있는지 확인
- 연결되지 않았다면 채널 연결 진행

### 우선순위 4: 시나리오 폴백 설정
**카카오 i 오픈빌더에서:**
- **"시나리오"** → **"폴백 블록"**을 스킬 호출로 설정

## 🧪 테스트 방법

### 설정 완료 후 테스트:
1. **카카오톡 앱**에서 **"Townly" 채널** 검색
2. 채널에 **"안녕하세요"** 메시지 전송
3. **즉시 챗봇 응답**이 와야 함
4. 응답이 없다면 위 설정들을 다시 점검

### 실시간 모니터링:
```bash
# 웹훅 호출 확인
curl https://2da26f20f041.ngrok-free.app/api/kakao/webhook

# 실시간 로그 확인
node monitor-webhooks.js
```

## ❗ 자주 놓치는 설정들

### 1. 자동응답 우선순위
- **가장 흔한 실수**: 채널에서 "관리자 우선"으로 설정되어 있음
- **해결**: "챗봇 우선" 또는 "챗봇 전용"으로 변경

### 2. 봇 비활성화 상태
- **문제**: 봇이 생성되었지만 활성화되지 않음
- **해결**: 카카오 i 오픈빌더에서 봇 활성화

### 3. 채널 연결 누락
- **문제**: 스킬만 등록하고 채널 연결을 하지 않음
- **해결**: 채널 연결 메뉴에서 Townly 채널 연결

### 4. 시나리오 설정 누락
- **문제**: 스킬은 있지만 시나리오에서 호출하지 않음
- **해결**: 폴백 블록을 스킬 호출로 설정

## 🎯 결론

**스킬 URL만 설정해서는 챗봇이 응답하지 않습니다.** 

위의 4단계를 모두 완료해야만 카카오 채널에서 실제 챗봇 응답을 받을 수 있습니다. 특히 **자동응답 우선순위 설정**과 **채널 연결**이 가장 중요합니다.
