---
alwaysApply: false
---
# description: MetaTrans í”„ë¡œì íŠ¸ ì „ì²´ ê·œì¹™( DTO Â· Database Â· Data Handling Â· í•„ë“œ ë§¤í•‘ í†µí•© ë§ˆìŠ¤í„° ê·œì¹™ )

# ğŸ›ï¸ MetaTrans Master Rules  
### DTO Â· Database Handling Â· Field Mapping í†µí•© ê·œì¹™ ì„¸íŠ¸  
(ëª¨ë“  íŒ€ì›ì´ ë°˜ë“œì‹œ ì¤€ìˆ˜í•´ì•¼ í•˜ëŠ” ë‹¨ì¼ ê¶Œìœ„ ê·œì¹™)

---

# ğŸš¨ 0. ABSOLUTE RULES (í”„ë¡œì íŠ¸ ì „ì²´ ì ˆëŒ€ ê·œì¹™)

### **1. DTO ë§¤í¼ ì—†ì´ DB ëª¨ë¸ì„ í´ë¼ì´ì–¸íŠ¸ë¡œ ì „ë‹¬ ê¸ˆì§€**
### **2. Server Components/Server Actions ì™¸ë¶€ì—ì„œ DB ì ‘ê·¼ ê¸ˆì§€**
### **3. ëª¨ë“  DB ì ‘ê·¼ì€ ë°˜ë“œì‹œ `db/queries` í—¬í¼ë§Œ ì‚¬ìš©**
### **4. ëª¨ë“  ì…ë ¥ ë°ì´í„°ëŠ” Zodë¡œ ê²€ì¦**
### **5. snake_case â†” camelCase ë³€í™˜ì€ DTO ë§¤í¼ì—ì„œë§Œ ì²˜ë¦¬**
### **6. Date/number/array/object ë³€í™˜ì€ ë°˜ë“œì‹œ ì•ˆì „ ë³€í™˜ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©**
### **7. í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ëŠ” DTO íƒ€ì…ë§Œ ì‚¬ìš© (DB íƒ€ì… ì§ì ‘ ì‚¬ìš© ê¸ˆì§€)**

---

# ğŸ“¦ 1. DTO PATTERN MASTER RULES  
### (ê¸°ì¡´: comprehensive-dto-pattern-guide.mdc)

## 1.1 MUST (í•„ìˆ˜)
- `dto-mappers.ts`, `admin-dto-mappers.ts` **ë§¤í¼ í•„ìˆ˜ ì‚¬ìš©**
- ëª¨ë“  **DB â†’ í´ë¼ì´ì–¸íŠ¸** ë°ì´í„°ëŠ” ë°˜ë“œì‹œ DTOë¥¼ ê±°ì³ì•¼ í•¨
- **ë‚ ì§œ(Date)** â†’ ë°˜ë“œì‹œ ISO string ë³€í™˜
- **snake_case â†’ camelCase ë³€í™˜ í•„ìˆ˜**
- **ì•ˆì „ ë³€í™˜ ìœ í‹¸ë¦¬í‹°** ì‚¬ìš©:  
  `toISOString`, `toSafeArray`, `toRecord`, `mapArraySafely`, `toSafeNumber`
- **ê´€ë¦¬ì í˜ì´ì§€**ëŠ” ì „ìš© admin DTOë§Œ ì‚¬ìš©
- APIëŠ” ë°˜ë“œì‹œ `createSuccessResponse` / `createErrorResponse` ì‚¬ìš©

## 1.2 MUST NOT (ê¸ˆì§€)
- DB íƒ€ì…ì„ í´ë¼ì´ì–¸íŠ¸ë¡œ ì§ì ‘ ì „ë‹¬
- ìë™ ë³€í™˜ ê¸°ëŒ€ (íŠ¹íˆ ë‚ ì§œ)
- unknown/null/undefinedë¥¼ ê·¸ëŒ€ë¡œ ë Œë”ë§
- ê´€ë¦¬ì ë°ì´í„°ì— ê¸°ë³¸ DTO ì‚¬ìš© ê¸ˆì§€

---

# ğŸ“š 2. Data Handling & Database Rules  
### (ê¸°ì¡´: database-and-data-handling.mdc)

## 2.1 Database Access Rules
### MUST
- DB ì ‘ê·¼ì€ `db/queries/*.ts` íŒŒì¼ì—ì„œë§Œ
- Drizzle ORM + Type-safe schema ì‚¬ìš©
- ëª¨ë“  ì¿¼ë¦¬ í•¨ìˆ˜ëŠ” í…Œì´ë¸” ë‹¨ìœ„ë¡œ ë¶„ë¦¬ (`getX`, `createX` ë“±)

### MUST NOT
- ì»´í¬ë„ŒíŠ¸/ì„œë²„ì•¡ì…˜ì—ì„œ `db` ì§ì ‘ import
- ì¸ë¼ì¸ Drizzle ì¿¼ë¦¬
- Raw SQL
- Prisma/TypeORM ë“± ì™¸ë¶€ ORM ì‚¬ìš©

---

## 2.2 Authentication & Security Rules
- Clerk `auth()`ë¡œ userId í•„ìˆ˜ í™•ì¸
- userId ê¸°ë°˜ ë°ì´í„° ê²©ë¦¬ í•„ìˆ˜
- ì„œë²„ ì¸¡ì—ì„œ ê¶Œí•œ ê²€ì¦ ìˆ˜í–‰

---

## 2.3 Data Retrieval Rules
### MUST
- ëª¨ë“  fetchëŠ” **Server Component**ì—ì„œ
- ë°˜ë“œì‹œ `db/queries` ì‚¬ìš©

### MUST NOT
- í´ë¼ì´ì–¸íŠ¸ fetching (`useEffect`, `useSWR`)
- CRUD ì „ìš© API Route

---

## 2.4 Data Mutation Rules
### MUST
- `'use server'` Server Actionì—ì„œë§Œ
- Server Actions ë‚´ë¶€ì—ì„œ `db/queries` í˜¸ì¶œ
- Zodë¡œ ëª¨ë“  ì…ë ¥ ê²€ì¦

### MUST NOT
- í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì§ì ‘ mutate
- Server Actionsì—ì„œ db ì§ì ‘ import
- CRUD API Route ìƒì„±

---

# ğŸ§± 3. DB Schema & Field Mapping Rules  
### (ê¸°ì¡´: database-field-mapping.mdc)

## 3.1 í•„ë“œ ë„¤ì´ë° ê·œì¹™
- ìŠ¤í‚¤ë§ˆ í•„ë“œëŠ” **ê·¸ëŒ€ë¡œ ì‚¬ìš©**
- ëŒ€ë¶€ë¶„ camelCase  
- ì¼ë¶€ í…Œì´ë¸”(professionals ë“±) snake_case

---

## 3.2 snake_case â†” camelCase ë§¤í•‘ ê·œì¹™
### DB â†’ Client (DTO ë§¤í¼ì—ì„œë§Œ ì²˜ë¦¬)
```typescript
createdAt: toISO(db.created_at)
updatedAt: toISO(db.updated_at)
```

### Client â†’ DB (server actionsì—ì„œë§Œ)
```typescript
camelToSnake(input)
```

---

## 3.3 ë‚ ì§œ ë³€í™˜ ê·œì¹™
```typescript
function toISO(d: Date | string) { ... }
function toISOOrNull(d: Date | string | null) { ... }
function toDateString(d: Date | string | null) { ... }
```

---

## 3.4 ìˆ«ì ë³€í™˜ ê·œì¹™
```typescript
const toSafeNumber = (v: unknown): number => ...
```

---
# ğŸ”§ 4. Standard Utility Functions
(ì „ íŒŒì¼ ê¸°ì¤€ í†µí•©)

## ğŸš€ í•„ìˆ˜ ìœ í‹¸ë¦¬í‹° (ë°˜ë“œì‹œ ì‚¬ìš©)
```typescript
toISOString(date)
toISOStringOrNull(date)
toSafeNumber(value)
toSafeArray(value)
toRecord(value)
mapArraySafely(array, mapFn)
mapNestedObject(obj, defaultValue)
snakeToCamel(obj)
camelToSnake(obj)
```

---
# ğŸ—ï¸ 5. DTO Mapper Standard Templates

## 5.1 ê¸°ë³¸ ì—”í‹°í‹° ë§¤í¼
```typescript
export function map<Entity>ForClient(db: Entity): ClientEntity {
  return {
    ...db,
    createdAt: toISOStringOrNull(db.created_at),
    updatedAt: toISOStringOrNull(db.updated_at),
  }
}
```

## 5.2 ê´€ë¦¬ì ì „ìš© ë§¤í¼
```typescript
export function map<Entity>ManagementForClient(db: MgmtEntity) {
  return {
    id: db.id,
    createdAt: toISOString(db.created_at),
    totalTests: toSafeNumber(db.totalTests),
    specialties: toSafeArray(db.specialties),
  }
}
```

---
# ğŸ—„ï¸ 6. Query Function Rules (db/queries)

## MUST
- í…Œì´ë¸” ë‹¨ìœ„ë¡œ queries íŒŒì¼ ë¶„ë¦¬
- ëª¨ë“  í•¨ìˆ˜ëª… ëª…í™•: getTestById, createQuestion, ...

## MUST NOT
- db ì§ì ‘ ì ‘ê·¼ ê¸ˆì§€
- Snake/camel ë³€í™˜ ì—†ì´ í•„ë“œ ì„ì˜ ìƒì„± ê¸ˆì§€

---

# ğŸ› ï¸ 7. Server Actions & Validation Pattern

```typescript
'use server'

import { z } from 'zod'
import { auth } from '@clerk/nextjs'
import { createPortfolio } from '@/db/queries/portfolios'

const Schema = z.object({
  title: z.string().min(1),
  category: z.enum(['a','b','c'])
})

export async function action(data: unknown) {
  const { userId } = auth()
  if (!userId) throw new Error('Unauthorized')

  const input = Schema.parse(data)
  return await createPortfolio({ ...input, userId })
}
```

---
# ğŸ§© 8. Server Component Rules

## MUST
```tsx
const test = await getTestById(id)
<TestClient initialTest={mapTestForClient(test)} />
```

## MUST NOT
```tsx
<TestClient initialTest={dbTest}>   // DB íƒ€ì… ê·¸ëŒ€ë¡œ ì „ë‹¬ ê¸ˆì§€
```

---
# ğŸ–¥ï¸ 9. Client Component Rules

## MUST
- DTO íƒ€ì…ë§Œ stateë¡œ ì‚¬ìš©

```typescript
const [tests, setTests] = useState<ClientTest[]>([])
```

---
# ğŸ“‹ 10. Unified Checklist (ë§ˆìŠ¤í„° ì²´í¬ë¦¬ìŠ¤íŠ¸)

## DTO
- [ ] DTO ë§¤í¼ ì‚¬ìš©?
- [ ] snake_case â†’ camelCase ë³€í™˜?
- [ ] ì•ˆì „ ë³€í™˜ ì ìš©(date/number/array/object)?

## Database
- [ ] ëª¨ë“  DB ì ‘ê·¼ db/queries ê²½ìœ ?
- [ ] Raw SQL ì—†ìŒ?
- [ ] userId ê¸°ë°˜ ê¶Œí•œ ê²€ì¦?

## Server Actions
- [ ] 'use server' ì„ ì–¸?
- [ ] Zod ê²€ì¦ ì™„ë£Œ?

## Components
- [ ] Server Componentì—ì„œë§Œ fetch?
- [ ] Client ComponentëŠ” DTOë§Œ ì‚¬ìš©?

## Field Mapping
- [ ] ìŠ¤í‚¤ë§ˆ í•„ë“œëª… ì •í™•íˆ ì‚¬ìš©?
- [ ] Timestamp ìˆ˜ë™ ì„¤ì • ê¸ˆì§€?

---

# ğŸ ê²°ë¡  (í•µì‹¬ ìš”ì•½ Top 3)

1. **DTO ë§¤í¼ ì—†ì´ ë°ì´í„°ë¥¼ ì „ë‹¬í•˜ëŠ” ëª¨ë“  ì½”ë“œëŠ” ê¸ˆì§€**
2. **DB ì ‘ê·¼ì€ ë°˜ë“œì‹œ db/queries, ë°ì´í„° ê²€ì¦ì€ Zodë¡œ í†µì¼**
3. **snake/camel ë³€í™˜, ë‚ ì§œ/ìˆ«ì/ë°°ì—´ ë³€í™˜ì€ ë°˜ë“œì‹œ ì•ˆì „ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©**