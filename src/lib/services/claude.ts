import Anthropic from '@anthropic-ai/sdk';
import { env } from '@/lib/env';

/**
 * Anthropic Claude API í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
 */
const anthropic = env.ANTHROPIC_API_KEY ? new Anthropic({
  apiKey: env.ANTHROPIC_API_KEY,
}) : null;

/**
 * Claudeì—ê²Œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê³  ì‘ë‹µì„ ë°›ëŠ” í•¨ìˆ˜
 */
export async function getClaudeResponse(userMessage: string, systemPrompt?: string): Promise<string> {
  try {
    // API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš°
    if (!anthropic) {
      throw new Error('Claude API key is not configured');
    }
    // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì„¤ì • (ì¹´ì¹´ì˜¤ ì±—ë´‡ì˜ ì»¨í…ìŠ¤íŠ¸ ì œê³µ)
    const defaultSystemPrompt = `ë‹¹ì‹ ì€ "Townly"ë¼ëŠ” í•˜ì´í¼ ë¡œì»¬ ì •ë³´ ì—ì´ì „íŠ¸ì…ë‹ˆë‹¤. ë‹¤ìŒê³¼ ê°™ì€ íŠ¹ì„±ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤:

ğŸ˜ï¸ **ì—­í• **: ì§€ì—­ ê¸°ë°˜ ë§›ì§‘, ì¹´í˜, í¸ì˜ì‹œì„¤ ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” ì¹œê·¼í•œ AI ì–´ì‹œìŠ¤í„´íŠ¸
ğŸ¯ **ëª©í‘œ**: ì‚¬ìš©ìì˜ ìœ„ì¹˜ë‚˜ ê´€ì‹¬ ì§€ì—­ì— ë§ëŠ” ì •í™•í•˜ê³  ìœ ìš©í•œ ë¡œì»¬ ì •ë³´ ì œê³µ
ğŸ’¬ **í†¤**: ì¹œê·¼í•˜ê³  ë„ì›€ì´ ë˜ëŠ” í†¤, ì´ëª¨ì§€ ì ì ˆíˆ ì‚¬ìš©

**ì£¼ìš” ê¸°ëŠ¥**:
- ë§›ì§‘ ë° ì¹´í˜ ì¶”ì²œ
- ì§€ì—­ë³„ í¸ì˜ì‹œì„¤ ì •ë³´ ì œê³µ  
- êµí†µ ì •ë³´ ì•ˆë‚´
- ë™ë„¤ ìƒí™œ ì •ë³´ ì œê³µ

**ì‘ë‹µ ê°€ì´ë“œë¼ì¸**:
1. í•œêµ­ì–´ë¡œ ì‘ë‹µ
2. êµ¬ì²´ì ì¸ ì§€ì—­ëª…ì´ ìˆìœ¼ë©´ í•´ë‹¹ ì§€ì—­ ì •ë³´ ì œê³µ
3. ì§€ì—­ëª…ì´ ì—†ìœ¼ë©´ êµ¬ì²´ì ì¸ ì§€ì—­ì„ ë¬¼ì–´ë³´ê¸°
4. ì‘ë‹µì€ ê°„ê²°í•˜ê³  ì‹¤ìš©ì ìœ¼ë¡œ (ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ íŠ¹ì„±ìƒ)
5. ì´ëª¨ì§€ ì ì ˆíˆ ì‚¬ìš©í•˜ì—¬ ì¹œê·¼ê° í‘œí˜„
6. ì •í™•í•˜ì§€ ì•Šì€ ì •ë³´ëŠ” ì œê³µí•˜ì§€ ì•Šê³  ì¼ë°˜ì ì¸ ì¡°ì–¸ ì œê³µ

ì‚¬ìš©ìê°€ ì§€ì—­ ì •ë³´ë‚˜ ë§›ì§‘ ê´€ë ¨ ì§ˆë¬¸ì„ í•˜ë©´ ìµœëŒ€í•œ ë„ì›€ì´ ë˜ëŠ” ë‹µë³€ì„ ì œê³µí•˜ì„¸ìš”.`;

    const finalSystemPrompt = systemPrompt || defaultSystemPrompt;

    // Claude API í˜¸ì¶œ (íƒ€ì„ì•„ì›ƒ ì„¤ì •)
    const message = await Promise.race([
      anthropic.messages.create({
        model: "claude-3-5-sonnet-20241022", // TODO: ëª¨ë¸ ì—…ë°ì´íŠ¸ í•„ìš” (2025ë…„ 10ì›” ì‚¬ìš© ì¤‘ë‹¨)
        max_tokens: 300, // ì¹´ì¹´ì˜¤í†¡ ì‘ë‹µ ì†ë„ ê°œì„ ì„ ìœ„í•´ ì¶•ì†Œ
        temperature: 0.5, // ì‘ë‹µ ì†ë„ë¥¼ ìœ„í•´ ì°½ì˜ì„± ì•½ê°„ ë‚®ì¶¤
        system: finalSystemPrompt,
        messages: [
          {
            role: "user",
            content: userMessage
          }
        ],
      }),
      new Promise((_, reject) => 
        setTimeout(() => reject(new Error('Claude API timeout')), 8000) // 8ì´ˆ íƒ€ì„ì•„ì›ƒ
      )
    ]) as Awaited<ReturnType<typeof anthropic.messages.create>>;

    // ì‘ë‹µ ì¶”ì¶œ
    const response = message.content[0];
    
    if (response.type !== 'text' || !response.text) {
      throw new Error('Claude ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
    }

    return response.text.trim();

  } catch (error) {
    console.error('Claude API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜:', error);
    
    // ì—ëŸ¬ ìœ í˜•ë³„ ì²˜ë¦¬
    if (error instanceof Error) {
      if (error.message.includes('API key') || error.message.includes('authentication')) {
        return 'ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ AI ì„œë¹„ìŠ¤ ì„¤ì •ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.';
      }
      
      if (error.message.includes('rate limit') || error.message.includes('quota')) {
        return 'ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ AI ì„œë¹„ìŠ¤ ì‚¬ìš©ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
      }
      
      if (error.message.includes('timeout')) {
        return 'ì‘ë‹µ ì²˜ë¦¬ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ì¢€ ë” ê°„ë‹¨í•œ ì§ˆë¬¸ìœ¼ë¡œ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
      }

      if (error.message.includes('overloaded')) {
        return 'ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ AI ì„œë¹„ìŠ¤ê°€ ê³¼ë¶€í•˜ ìƒíƒœì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
      }
    }
    
    // ê¸°ë³¸ ì—ëŸ¬ ì‘ë‹µ
    return 'ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
  }
}

/**
 * ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ë¶„ì„í•˜ì—¬ ë§ì¶¤í˜• ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ìƒì„±
 */
export function generateContextualSystemPrompt(userMessage: string): string {
  const lowerMessage = userMessage.toLowerCase();
  
  // ë§›ì§‘ ê´€ë ¨ ì§ˆë¬¸ì¸ ê²½ìš°
  if (lowerMessage.includes('ë§›ì§‘') || lowerMessage.includes('ìŒì‹') || lowerMessage.includes('ì‹ë‹¹')) {
    return `ë‹¹ì‹ ì€ "Townly" ë§›ì§‘ ì „ë¬¸ AIì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ë§›ì§‘ ê´€ë ¨ ì§ˆë¬¸ì„ í–ˆìŠµë‹ˆë‹¤.

ë‹¤ìŒ ê°€ì´ë“œë¼ì¸ì„ ë”°ë¼ ì‘ë‹µí•˜ì„¸ìš”:
1. êµ¬ì²´ì ì¸ ì§€ì—­ëª…ì´ ìˆìœ¼ë©´ í•´ë‹¹ ì§€ì—­ì˜ ì‹¤ì œ ë§›ì§‘ ì •ë³´ ì œê³µ
2. ì§€ì—­ëª…ì´ ì—†ìœ¼ë©´ "ì–´ë–¤ ì§€ì—­ì˜ ë§›ì§‘ì„ ì°¾ìœ¼ì‹œë‚˜ìš”?"ë¼ê³  ì§ˆë¬¸
3. ìŒì‹ ì¢…ë¥˜, ê°€ê²©ëŒ€, ë¶„ìœ„ê¸° ë“± êµ¬ì²´ì ì¸ ì •ë³´ í¬í•¨
4. ì´ëª¨ì§€ ì‚¬ìš©í•˜ì—¬ ì¹œê·¼í•˜ê²Œ í‘œí˜„
5. ì‘ë‹µì€ ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ íŠ¹ì„±ìƒ ê°„ê²°í•˜ê²Œ (500ì ì´ë‚´)

ì§€ì—­ë³„ ë§›ì§‘ ì •ë³´ë¥¼ ì •í™•í•˜ê³  ìœ ìš©í•˜ê²Œ ì œê³µí•´ì£¼ì„¸ìš”.`;
  }
  
  // êµí†µ/ìœ„ì¹˜ ê´€ë ¨ ì§ˆë¬¸ì¸ ê²½ìš°  
  if (lowerMessage.includes('êµí†µ') || lowerMessage.includes('ì§€í•˜ì² ') || lowerMessage.includes('ë²„ìŠ¤') || lowerMessage.includes('ê¸¸ì°¾ê¸°')) {
    return `ë‹¹ì‹ ì€ "Townly" êµí†µ ì •ë³´ AIì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ êµí†µ ê´€ë ¨ ì§ˆë¬¸ì„ í–ˆìŠµë‹ˆë‹¤.

ë‹¤ìŒ ê°€ì´ë“œë¼ì¸ì„ ë”°ë¼ ì‘ë‹µí•˜ì„¸ìš”:
1. ì¶œë°œì§€ì™€ ëª©ì ì§€ê°€ ëª…í™•í•˜ë©´ êµí†µ ë°©ë²• ì•ˆë‚´
2. ì •ë³´ê°€ ë¶€ì¡±í•˜ë©´ êµ¬ì²´ì ì¸ ìœ„ì¹˜ ì§ˆë¬¸
3. ì§€í•˜ì² , ë²„ìŠ¤, ë„ë³´ ë“± ë‹¤ì–‘í•œ êµí†µìˆ˜ë‹¨ ì •ë³´ ì œê³µ
4. ì†Œìš”ì‹œê°„ê³¼ ë¹„ìš© ì •ë³´ í¬í•¨ (ì¼ë°˜ì ì¸ ìˆ˜ì¤€ì—ì„œ)
5. ì‹¤ì‹œê°„ ì •ë³´ëŠ” ì œê³µí•  ìˆ˜ ì—†ìŒì„ ì•ˆë‚´

êµí†µ ì •ë³´ë¥¼ ì¹œê·¼í•˜ê³  ì‹¤ìš©ì ìœ¼ë¡œ ì œê³µí•´ì£¼ì„¸ìš”.`;
  }

  // ë‚ ì”¨ ê´€ë ¨ ì§ˆë¬¸ì¸ ê²½ìš°
  if (lowerMessage.includes('ë‚ ì”¨') || lowerMessage.includes('ê¸°ì˜¨') || lowerMessage.includes('ë¹„') || lowerMessage.includes('ëˆˆ')) {
    return `ë‹¹ì‹ ì€ "Townly" ë‚ ì”¨ ì •ë³´ AIì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ë‚ ì”¨ ê´€ë ¨ ì§ˆë¬¸ì„ í–ˆìŠµë‹ˆë‹¤.

ë‹¤ìŒ ê°€ì´ë“œë¼ì¸ì„ ë”°ë¼ ì‘ë‹µí•˜ì„¸ìš”:
1. ì‹¤ì‹œê°„ ë‚ ì”¨ ì •ë³´ëŠ” ì œê³µí•  ìˆ˜ ì—†ìŒì„ ì•ˆë‚´
2. ì¼ë°˜ì ì¸ ê³„ì ˆë³„ ë‚ ì”¨ ì •ë³´ë‚˜ ì˜·ì°¨ë¦¼ ì¡°ì–¸ ì œê³µ
3. ë‚ ì”¨ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆëŠ” ë°©ë²• ì•ˆë‚´
4. ì¹œê·¼í•˜ê³  ë„ì›€ì´ ë˜ëŠ” í†¤ìœ¼ë¡œ ì‘ë‹µ

ë‚ ì”¨ ê´€ë ¨ ì¡°ì–¸ì„ ì‹¤ìš©ì ìœ¼ë¡œ ì œê³µí•´ì£¼ì„¸ìš”.`;
  }
  
  // ê¸°ë³¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë°˜í™˜
  return `ë‹¹ì‹ ì€ "Townly"ë¼ëŠ” í•˜ì´í¼ ë¡œì»¬ ì •ë³´ ì—ì´ì „íŠ¸ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ì¹œê·¼í•˜ê³  ë„ì›€ì´ ë˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”.

ì§€ì—­ ì •ë³´, ë§›ì§‘, í¸ì˜ì‹œì„¤ ë“±ì— ëŒ€í•œ ì§ˆë¬¸ì´ë©´ êµ¬ì²´ì ìœ¼ë¡œ ë„ì›€ì„ ì£¼ê³ , 
ê·¸ ì™¸ì˜ ì§ˆë¬¸ì´ë©´ Townlyì˜ ì£¼ìš” ê¸°ëŠ¥ì„ ì•ˆë‚´í•˜ë©° ì§€ì—­ ê´€ë ¨ ì§ˆë¬¸ì„ ìœ ë„í•´ì£¼ì„¸ìš”.

í•œêµ­ì–´ë¡œ ì‘ë‹µí•˜ê³ , ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•˜ì—¬ ì¹œê·¼ê°ì„ í‘œí˜„í•˜ì„¸ìš”.`;
}

/**
 * Claude ì‘ë‹µ ê²€ì¦ ë° í›„ì²˜ë¦¬
 */
export function validateAndProcessResponse(response: string): string {
  // ì‘ë‹µ ê¸¸ì´ ì œí•œ (ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ íŠ¹ì„±ìƒ)
  if (response.length > 1000) {
    const truncated = response.substring(0, 950);
    const lastSentence = truncated.lastIndexOf('.');
    if (lastSentence > 500) {
      return truncated.substring(0, lastSentence + 1) + '\n\në” ìì„¸í•œ ì •ë³´ê°€ í•„ìš”í•˜ì‹œë©´ ì¶”ê°€ë¡œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”! ğŸ˜Š';
    }
    return truncated + '...\n\në” ìì„¸í•œ ì •ë³´ê°€ í•„ìš”í•˜ì‹œë©´ ì¶”ê°€ë¡œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”! ğŸ˜Š';
  }
  
  // ë¶€ì ì ˆí•œ ë‚´ìš© í•„í„°ë§ (ê¸°ë³¸ì ì¸ ìˆ˜ì¤€)
  const inappropriateWords = ['ìš•ì„¤', 'ë¹„ì†ì–´', 'ìŒë€', 'í­ë ¥'];
  if (inappropriateWords.some(word => response.includes(word))) {
    return 'ì£„ì†¡í•©ë‹ˆë‹¤. ê±´ì „í•œ ëŒ€í™”ë¥¼ ìœ„í•´ ë‹¤ë¥¸ ì£¼ì œë¡œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”. ğŸ˜Š';
  }
  
  return response;
}

/**
 * Claude ì‘ë‹µ ìºì‹±ì„ ìœ„í•œ í‚¤ ìƒì„±
 */
export function generateCacheKey(userMessage: string): string {
  // ë©”ì‹œì§€ë¥¼ ì •ê·œí™”í•˜ì—¬ ìºì‹œ í‚¤ ìƒì„±
  const normalized = userMessage.toLowerCase().trim().replace(/\s+/g, ' ');
  return `claude_${Buffer.from(normalized).toString('base64').substring(0, 50)}`;
}
