---
alwaysApply: true
description: "ë¯¸ë“¤ì›¨ì–´ ìˆ˜ì • ì‹œ ì£¼ì˜ì‚¬í•­ ë° ì•ˆì „ ê°€ì´ë“œ"
---

# ë¯¸ë“¤ì›¨ì–´ ìˆ˜ì • ì‹œ ì£¼ì˜ì‚¬í•­

ì´ ê·œì¹™ì€ Next.js + Clerk í™˜ê²½ì—ì„œ ë¯¸ë“¤ì›¨ì–´ ìˆ˜ì • ì‹œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œë¥¼ ì˜ˆë°©í•˜ê¸° ìœ„í•œ ê°€ì´ë“œì…ë‹ˆë‹¤.

## âš ï¸ í•µì‹¬ ì£¼ì˜ì‚¬í•­

### 1. ë¯¸ë“¤ì›¨ì–´ëŠ” ë§¤ìš° ë¯¼ê°í•œ íŒŒì¼ì…ë‹ˆë‹¤
- **`src/middleware.ts`**ëŠ” ëª¨ë“  ë¼ìš°íŠ¸ì˜ ì¸ì¦ì„ ë‹´ë‹¹í•˜ëŠ” í•µì‹¬ íŒŒì¼ì…ë‹ˆë‹¤
- ì˜ëª» ìˆ˜ì •í•˜ë©´ ì „ì²´ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì¸ì¦ì´ ì¤‘ë‹¨ë©ë‹ˆë‹¤
- **ê¸°ì¡´ ì •ìƒ ì‘ë™í•˜ëŠ” ì½”ë“œë¥¼ í•¨ë¶€ë¡œ ë³€ê²½í•˜ì§€ ë§ˆì„¸ìš”**

### 2. ë°œìƒí–ˆë˜ ë¬¸ì œ ì‚¬ë¡€
**ìƒí™©**: ì´ë©”ì¼ ê´€ë¦¬ ê¸°ëŠ¥ ê°œë°œ ì¤‘ ë¯¸ë“¤ì›¨ì–´ë¥¼ ìˆ˜ì •í•œ í›„, ë¯¸ì„¸ë¨¼ì§€ ë° ì¹´ì¹´ì˜¤ ê´€ë¦¬ í˜ì´ì§€ ì ‘ê·¼ ë¶ˆê°€

**ì›ì¸**: 
```typescript
// âŒ ë¬¸ì œê°€ ëœ ì½”ë“œ (ì˜ëª»ëœ ìˆ˜ì •)
export default clerkMiddleware((auth, req) => {
  if (isProtectedRoute(req)) {
    auth().protect();  // ì´ ë°©ì‹ì´ ë¬¸ì œ
  }
});

// âœ… ì›ë˜ ì •ìƒ ì‘ë™í•˜ë˜ ì½”ë“œ
export default clerkMiddleware(async (auth, req) => {
  const { userId } = await auth();
  
  if (isProtectedRoute(req) && !userId) {
    const signInUrl = new URL('/sign-in', req.url);
    return NextResponse.redirect(signInUrl);
  }
});
```

## ğŸ“‹ ë¯¸ë“¤ì›¨ì–´ ìˆ˜ì • ì‹œ ì•ˆì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ìˆ˜ì • ì „ í•„ìˆ˜ í™•ì¸ì‚¬í•­
- [ ] í˜„ì¬ ë¯¸ë“¤ì›¨ì–´ê°€ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸
- [ ] ê¸°ì¡´ ì½”ë“œë¥¼ ë°±ì—… (git commit ë˜ëŠ” ë³µì‚¬)
- [ ] ë³€ê²½ ì´ìœ ê°€ ëª…í™•í•œì§€ í™•ì¸

### ìˆ˜ì • ì¤‘ ì¤€ìˆ˜ì‚¬í•­
- [ ] ê¸°ì¡´ í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ ìœ ì§€: `async (auth, req)`
- [ ] `await auth()` íŒ¨í„´ ìœ ì§€
- [ ] `NextResponse.redirect()` ë°©ì‹ ìœ ì§€
- [ ] ë³´í˜¸ëœ ë¼ìš°íŠ¸ ëª©ë¡ ë³€ê²½ ì‹œ ì‹ ì¤‘íˆ ê²€í† 

### ìˆ˜ì • í›„ í•„ìˆ˜ í…ŒìŠ¤íŠ¸
- [ ] ëª¨ë“  ë³´í˜¸ëœ í˜ì´ì§€ ì ‘ê·¼ í…ŒìŠ¤íŠ¸
  - `/dashboard`
  - `/profile` 
  - `/admin/kakao`
  - `/admin/email-management`
  - `/airquality`
- [ ] ë¡œê·¸ì¸ ìƒíƒœì—ì„œ ì ‘ê·¼ ê°€ëŠ¥ í™•ì¸
- [ ] ë¹„ë¡œê·¸ì¸ ìƒíƒœì—ì„œ ë¦¬ë‹¤ì´ë ‰ì…˜ í™•ì¸

## ğŸš¨ ë¬¸ì œ ë°œìƒ ì‹œ ëŒ€ì‘ë²•

### 1. ì¦‰ì‹œ ì›ë³µ
```bash
# Gitìœ¼ë¡œ ì´ì „ ì •ìƒ ìƒíƒœë¡œ ë³µì›
git checkout HEAD -- src/middleware.ts
```

### 2. ì›ë˜ ì •ìƒ ì½”ë“œ í…œí”Œë¦¿
```typescript
import { clerkMiddleware, createRouteMatcher } from "@clerk/nextjs/server";
import { NextResponse } from "next/server";

const isProtectedRoute = createRouteMatcher([
  '/dashboard(.*)',
  '/profile(.*)',
  '/settings(.*)',
  '/admin(.*)',
  '/airquality(.*)',
]);

export default clerkMiddleware(async (auth, req) => {
  const { userId } = await auth();
  
  if (isProtectedRoute(req) && !userId) {
    const signInUrl = new URL('/sign-in', req.url);
    return NextResponse.redirect(signInUrl);
  }
});

export const config = {
  matcher: [
    "/((?!_next|[^?]*\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)",
    "/(api|trpc)(.*)",
  ],
};
```

## ğŸ’¡ ê¶Œì¥ì‚¬í•­

### ìƒˆ ê¸°ëŠ¥ ì¶”ê°€ ì‹œ
1. **ë¯¸ë“¤ì›¨ì–´ ìˆ˜ì • ëŒ€ì‹  í˜ì´ì§€ ë ˆë²¨ ì¸ì¦ ê³ ë ¤**
   ```typescript
   // í˜ì´ì§€ì—ì„œ ì§ì ‘ ì¸ì¦ ì²´í¬
   export default async function MyPage() {
     const { userId } = await auth();
     if (!userId) {
       redirect('/sign-in');
     }
     // ...
   }
   ```

2. **ë¯¸ë“¤ì›¨ì–´ ìˆ˜ì •ì´ ê¼­ í•„ìš”í•œ ê²½ìš°**
   - ë‹¨ê³„ì  ì ‘ê·¼: ë¡œê·¸ ì¶”ê°€ â†’ í…ŒìŠ¤íŠ¸ â†’ ë³€ê²½ â†’ í…ŒìŠ¤íŠ¸
   - ë³€ê²½ ë²”ìœ„ ìµœì†Œí™”
   - ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ë° ê²€ì¦

### ë””ë²„ê¹… íŒ
```typescript
// ì„ì‹œ ë¡œê·¸ ì¶”ê°€ (ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ì œê±°)
export default clerkMiddleware(async (auth, req) => {
  console.log('ğŸ”„ Middleware for:', req.nextUrl.pathname);
  
  const { userId } = await auth();
  console.log('ğŸ‘¤ UserId:', userId);
  
  if (isProtectedRoute(req) && !userId) {
    console.log('âŒ Redirecting to sign-in');
    const signInUrl = new URL('/sign-in', req.url);
    return NextResponse.redirect(signInUrl);
  }
  
  console.log('âœ… Access granted');
});
```

## ğŸ“š ì°¸ê³ ì‚¬í•­

- Clerk v6+ ì—ì„œëŠ” `async/await` íŒ¨í„´ì´ í‘œì¤€ì…ë‹ˆë‹¤
- `auth().protect()` ë°©ì‹ì€ íŠ¹ë³„í•œ ê²½ìš°ì—ë§Œ ì‚¬ìš©í•˜ì„¸ìš”
- ë¯¸ë“¤ì›¨ì–´ëŠ” ì„œë²„ ì‚¬ì´ë“œì—ì„œë§Œ ì‹¤í–‰ë˜ë¯€ë¡œ í´ë¼ì´ì–¸íŠ¸ ìƒíƒœì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤

**ê¸°ì–µí•˜ì„¸ìš”: ë¯¸ë“¤ì›¨ì–´ëŠ” ì „ì²´ ì•±ì˜ ê´€ë¬¸ì…ë‹ˆë‹¤. ì‹ ì¤‘í•˜ê²Œ ë‹¤ë£¨ì„¸ìš”!**