# 🔄 카카오 완전한 웹훅 라우팅 설정 가이드

## 🎯 목표
모든 사용자 메시지(날씨 질문 포함)를 웹훅(`/api/kakao/webhook`)으로 라우팅하여 통합 처리

## 📋 현재 문제
- 날씨 질문이 별도 스킬(`/api/kakao/skills/weather-rag`)로 라우팅됨
- 이로 인해 메시지 저장 및 admin 페이지 표시 문제 발생

## ✅ 해결 방안: 완전한 웹훅 라우팅

### 🔧 **1단계: 카카오 i 오픈빌더 설정 변경**

#### A. 카카오 i 오픈빌더 접속
1. **카카오 i 오픈빌더** (https://i.kakao.com/) 접속
2. **"townly" 봇** 선택

#### B. 기존 날씨 스킬 비활성화
1. **"스킬"** 메뉴 클릭
2. 날씨 관련 스킬들 확인:
   - `weather-rag` 스킬
   - `weather` 스킬
3. **각 스킬의 "비활성화"** 버튼 클릭
4. ⚠️ **중요**: 스킬을 삭제하지 말고 비활성화만 하세요

#### C. 웹훅 스킬 설정 확인/수정
1. **"스킬"** 메뉴에서 **웹훅 스킬** 찾기
2. 스킬 URL이 다음과 같이 설정되어 있는지 확인:
   ```
   https://townly.vercel.app/api/kakao/webhook
   ```
3. 스킬이 **"활성화"** 상태인지 확인

#### D. 시나리오 설정 (가장 중요!)
1. **"시나리오"** 메뉴 클릭
2. **"폴백 블록"** 설정:
   ```
   폴백 블록 → 스킬 호출 → 웹훅 스킬 선택
   ```
3. **"Welcome 블록"** 설정:
   ```
   Welcome 블록 → 스킬 호출 → 웹훅 스킬 선택
   ```

#### E. 엔티티 및 인텐트 설정 제거
1. **"엔티티"** 메뉴에서 날씨 관련 엔티티 **비활성화**
2. **"인텐트"** 메뉴에서 날씨 관련 인텐트 **비활성화**
3. ⚠️ **중요**: 특정 인텐트가 날씨 스킬로 라우팅되지 않도록 모든 설정 제거

### 🔧 **2단계: 시나리오 플로우 확인**

#### 올바른 플로우:
```
사용자 메시지 입력
    ↓
폴백 블록 (모든 메시지 처리)
    ↓
웹훅 스킬 호출
    ↓
/api/kakao/webhook 엔드포인트
    ↓
날씨 질문 감지 로직
    ↓
[날씨 질문] → 에이전트 RAG 시스템
[일반 대화] → Claude 시스템
    ↓
통합 응답 제공
```

#### 잘못된 플로우 (현재):
```
사용자 메시지 입력
    ↓
인텐트 분석
    ↓
[날씨 관련] → weather-rag 스킬
[일반 대화] → 웹훅 스킬
    ↓
분리된 처리 (문제!)
```

### 🔧 **3단계: 테스트 및 검증**

#### A. 테스트 메시지들
다음 메시지들이 모두 웹훅으로 라우팅되는지 확인:

**날씨 질문:**
- "오늘 날씨 어때?"
- "내일 비가 오나?"
- "9월 29일 날씨를 알려줘"

**일반 대화:**
- "안녕하세요"
- "맛집 추천해줘"
- "고마워"

#### B. 확인 사항
1. **서버 로그**에서 다음 메시지 확인:
   ```
   🔍 날씨 질문 감지: true (신뢰도: 0.85)
   🌤️ 날씨 질문으로 감지됨 - 에이전트 RAG 시스템 호출
   ```

2. **Admin 페이지**에서 모든 메시지가 표시되는지 확인

3. **응답 타입** 확인:
   - 날씨 질문: `weather_agent_rag`
   - 일반 대화: `claude`

### 🚨 **주의사항**

#### A. 백업
- 설정 변경 전 현재 시나리오 설정을 **스크린샷**으로 백업
- 스킬을 삭제하지 말고 **비활성화**만 하세요

#### B. 점진적 적용
1. 먼저 **테스트 환경**에서 확인
2. 정상 작동 확인 후 **프로덕션 적용**

#### C. 롤백 계획
문제 발생 시:
1. 날씨 스킬 **재활성화**
2. 시나리오에서 **인텐트 기반 라우팅** 복원

### 📊 **예상 결과**

#### Before (현재):
```
"9월 29일 날씨를 알려줘"
    ↓
weather-rag 스킬 (/api/kakao/skills/weather-rag)
    ↓
DB 저장 안됨 → Admin 페이지에 표시 안됨
```

#### After (목표):
```
"9월 29일 날씨를 알려줘"
    ↓
웹훅 (/api/kakao/webhook)
    ↓
날씨 감지 → 에이전트 RAG 호출
    ↓
DB 저장됨 → Admin 페이지에 표시됨
```

### 🎯 **설정 완료 후 기대 효과**

1. **✅ 통합 메시지 관리**: 모든 메시지가 admin 페이지에서 확인 가능
2. **✅ 일관된 응답 품질**: 에이전트 기반 날씨 응답
3. **✅ 간편한 디버깅**: 단일 엔드포인트로 모든 로그 확인
4. **✅ 확장성**: 새로운 기능 추가 시 웹훅에서 통합 처리

---

## 🔧 **실행 체크리스트**

- [ ] 카카오 i 오픈빌더 접속
- [ ] 날씨 관련 스킬들 비활성화
- [ ] 웹훅 스킬 활성화 확인
- [ ] 폴백 블록 → 웹훅 스킬 연결
- [ ] 날씨 관련 인텐트/엔티티 비활성화
- [ ] 테스트 메시지 전송
- [ ] 서버 로그 확인
- [ ] Admin 페이지 확인

**이 가이드를 따라 설정하면 모든 메시지가 웹훅으로 라우팅되어 통합 처리됩니다!** 🎉
