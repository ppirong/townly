# 카카오 채널-챗봇 연동 문제 해결 가이드

## 🚨 문제 상황
- **증상**: 실제 고객이 카카오 채널에 메시지를 보내면 채널 앱에는 표시되지만 챗봇으로 전달되지 않음
- **테스트**: 개발 테스트 메시지는 정상적으로 챗봇에 도달함
- **현재 ngrok URL**: `https://2da26f20f041.ngrok-free.app/api/kakao/webhook`

## 🔍 점검 체크리스트

### 1. 카카오 i 오픈빌더 설정 확인
**카카오 i 오픈빌더 (https://i.kakao.com/)에서 확인해야 할 항목:**

#### ✅ 봇 기본 설정
- [ ] 봇이 **활성화** 상태인지 확인
- [ ] 봇 이름이 "townly"로 설정되었는지 확인
- [ ] 채널 연결이 정상적으로 되어있는지 확인

#### ✅ 채널 연결 상태
- [ ] "채널 연결" 메뉴에서 "Townly" 채널이 연결되어 있는지 확인
- [ ] 연결 상태가 **"정상"** 또는 **"연결됨"**으로 표시되는지 확인
- [ ] 채널 ID가 일치하는지 확인: `68bef0501c4ef66e4f5d73be`

#### ✅ 스킬 설정
- [ ] "스킬" 메뉴에서 웹훅 스킬이 등록되어 있는지 확인
- [ ] 스킬 URL이 정확한지 확인: `https://2da26f20f041.ngrok-free.app/api/kakao/webhook`
- [ ] 스킬이 **활성화** 상태인지 확인
- [ ] "기본 응답"이 스킬로 설정되어 있는지 확인

#### ✅ 시나리오 설정
- [ ] "시나리오" 메뉴에서 **"폴백 블록"**이 스킬을 호출하도록 설정되었는지 확인
- [ ] 모든 사용자 입력이 스킬로 전달되도록 설정되었는지 확인
- [ ] "채널 연결 후 기본 대화 흐름"이 스킬로 설정되었는지 확인

### 2. 카카오톡 채널 관리자센터 설정 확인
**카카오톡 채널 관리자센터 (https://center-pf.kakao.com/)에서 확인:**

#### ✅ 채널 기본 설정
- [ ] 채널이 **공개** 상태인지 확인
- [ ] 검색 허용이 **활성화**되어 있는지 확인
- [ ] 채널 URL: `https://pf.kakao.com/_wcyDn`이 정상 접근 가능한지 확인

#### ✅ 챗봇 설정
- [ ] "관리 > 채팅" 메뉴에서 **"챗봇 연결"**이 활성화되어 있는지 확인
- [ ] 연결된 챗봇이 "townly"인지 확인
- [ ] 자동응답이 **챗봇 우선**으로 설정되어 있는지 확인

### 3. 네트워크 및 보안 설정 확인

#### ✅ ngrok 설정
- [ ] ngrok이 정상적으로 실행 중인지 확인
- [ ] ngrok URL이 외부에서 접근 가능한지 확인: `curl https://2da26f20f041.ngrok-free.app/api/health`
- [ ] ngrok의 웹 인터페이스 (http://localhost:4040)에서 요청 로그 확인

#### ✅ 웹훅 엔드포인트 확인
```bash
# 1. 헬스체크
curl https://2da26f20f041.ngrok-free.app/api/health

# 2. 웹훅 테스트
curl -X POST https://2da26f20f041.ngrok-free.app/api/kakao/webhook \
  -H "Content-Type: application/json" \
  -d '{"userRequest":{"utterance":"테스트"}}'
```

### 4. 실시간 디버깅 방법

#### ✅ 로그 모니터링
```bash
# 실시간 웹훅 모니터링 (이미 실행 중)
node monitor-webhooks.js

# 디버깅 페이지 확인
open http://localhost:3000/debug/messages
```

#### ✅ ngrok 요청 로그 확인
1. 브라우저에서 http://localhost:4040 접속
2. "Inspect" 탭에서 실시간 요청 모니터링
3. 실제 고객이 메시지를 보낼 때 요청이 들어오는지 확인

### 5. 가장 가능성 높은 원인들

#### 🎯 원인 1: 챗봇이 비활성화 상태
**해결책**: 카카오 i 오픈빌더에서 봇을 활성화

#### 🎯 원인 2: 시나리오 설정 문제
**해결책**: 폴백 블록이 스킬을 호출하도록 설정

#### 🎯 원인 3: 채널-챗봇 연결 문제
**해결책**: 채널 관리자센터에서 챗봇 연결 재설정

#### 🎯 원인 4: 자동응답 우선순위 설정
**해결책**: 채널에서 챗봇 우선 또는 챗봇 전용으로 설정

## 🔧 즉시 확인할 항목들

### 우선순위 1: 카카오 i 오픈빌더
1. **봇 상태**: 활성화되어 있는가?
2. **채널 연결**: 정상 연결되어 있는가?
3. **기본 스킬**: 웹훅 스킬이 기본으로 설정되어 있는가?

### 우선순위 2: 카카오톡 채널 관리자센터
1. **챗봇 설정**: 챗봇이 연결되어 있는가?
2. **자동응답**: 챗봇 우선으로 설정되어 있는가?

### 우선순위 3: 네트워크
1. **ngrok**: 정상 작동하는가?
2. **웹훅 URL**: 외부에서 접근 가능한가?

## 📞 문제 해결 순서

1. **카카오 i 오픈빌더** 접속하여 봇 상태 확인
2. **채널 연결 상태** 확인 및 재연결 시도
3. **시나리오 설정**에서 폴백 블록을 스킬로 설정
4. **카카오톡 채널 관리자센터**에서 챗봇 설정 확인
5. **테스트 메시지** 전송하여 웹훅 호출 확인

위 항목들을 순서대로 확인하면 문제를 해결할 수 있습니다.
