# ìƒí’ˆë³„ ìµœì €ê°€ ë¶„ì„ ì‹œìŠ¤í…œ êµ¬í˜„ ê°€ì´ë“œ

## 1. ê°œìš”

ì´ ë¬¸ì„œëŠ” ë§ˆíŠ¸ë³„ ì „ë‹¨ì§€ í• ì¸ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒí’ˆë³„ ìµœì € ê°€ê²© ì •ë³´ë¥¼ ë„ì¶œí•˜ëŠ” ì‹œìŠ¤í…œì˜ êµ¬í˜„ ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

### ìš”êµ¬ì‚¬í•­
- ì „ì²´ ë§ˆíŠ¸ì— ëŒ€í•´ ì „ë‹¨ì§€ì— ë“±ë¡ëœ ê°œë³„ ìƒí’ˆë³„ë¡œ ìµœì € ê°€ê²© ì •ë³´ ë„ì¶œ
- ê° ìƒí’ˆì— ëŒ€í•œ ìµœì € ê°€ê²© êµ¬ì… ê°€ëŠ¥ ë§ˆíŠ¸ ì´ë¦„, í• ì¸ ë‚ ì§œ, ìµœì € ê°€ê²© ìš”ì•½
- ì˜ˆì‹œ: í•œëˆì•”ë¼ì§€ ìƒì‚¼ê²¹ì‚´ 600gì„ ìµœì € ê°€ê²©ìœ¼ë¡œ êµ¬ì…í•  ìˆ˜ ìˆëŠ” ë§ˆíŠ¸ëŠ” ì€ì„±ë§ˆíŠ¸ì´ê³ , 10ì›” 16ì¼ì— 11,000ì›ì— êµ¬ì… ê°€ëŠ¥

### í˜„ì¬ ë°ì´í„° êµ¬ì¡°
- **marts**: ë§ˆíŠ¸ ê¸°ë³¸ ì •ë³´
- **martDiscounts**: ë§ˆíŠ¸ë³„ í• ì¸ ì „ë‹¨ì§€ ë©”íƒ€ ì •ë³´
- **martDiscountItems**: ë‚ ì§œë³„ í• ì¸ ìƒí’ˆ ì •ë³´ (ìƒí’ˆëª…, ê°€ê²© í¬í•¨)

## 2. ê¸°ìˆ  ìŠ¤íƒ

### í•µì‹¬ ê¸°ìˆ 
- **Next.js 15** (App Router)
- **TypeScript** (íƒ€ì… ì•ˆì „ì„±)
- **Drizzle ORM** (ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬)
- **PostgreSQL** (ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤)
- **Zod** (ë°ì´í„° ê²€ì¦)

### ì¶”ê°€ í•„ìš” ê¸°ìˆ 
- **ExcelJS** (ì—‘ì…€ íŒŒì¼ ìƒì„±)
- **OpenAI Embeddings** (ë²¡í„° ì„ë² ë”©, ì„ íƒì‚¬í•­)
- **pgvector** (PostgreSQL ë²¡í„° í™•ì¥, ì„ íƒì‚¬í•­)

## 3. êµ¬í˜„ ë°©ë²• ë¹„êµ

### ë°©ë²• 1: ìˆœìˆ˜ ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ë²• â­ï¸ **ì¶”ì²œ**
**ì¥ì :**
- 100% ì •í™•í•œ ê²°ê³¼ ë³´ì¥
- ë¹ ë¥¸ ì¿¼ë¦¬ ì„±ëŠ¥
- ì‹¤ì‹œê°„ ë¶„ì„ ê°€ëŠ¥
- ì˜¤ë¥˜ ë°œìƒ ê°€ëŠ¥ì„± ìµœì†Œ

**ë‹¨ì :**
- ìƒí’ˆëª… ì •ê·œí™” í•„ìš”
- ë™ì¼ ìƒí’ˆì˜ ë‹¤ë¥¸ í‘œê¸°ë²• ì²˜ë¦¬ ì–´ë ¤ì›€

### ë°©ë²• 2: ë²¡í„° DB + RAG ì ‘ê·¼ë²•
**ì¥ì :**
- ìœ ì‚¬í•œ ìƒí’ˆëª… ìë™ ë§¤ì¹­
- ìì—°ì–´ ì²˜ë¦¬ ê°€ëŠ¥
- AI ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸ ì œê³µ

**ë‹¨ì :**
- ì„ë² ë”© ë¹„ìš© ë°œìƒ
- ê²°ê³¼ì˜ ì •í™•ì„± ë³´ì¥ ì–´ë ¤ì›€
- ë³µì¡í•œ êµ¬í˜„

### ë°©ë²• 3: í•˜ì´ë¸Œë¦¬ë“œ ì ‘ê·¼ë²• â­ï¸ **ìµœì¢… ì¶”ì²œ**
**1ì°¨: ë°ì´í„°ë² ì´ìŠ¤ ì •í™• ë§¤ì¹­**
**2ì°¨: ë²¡í„° ê²€ìƒ‰ìœ¼ë¡œ ìœ ì‚¬ ìƒí’ˆ ë³´ì™„**

## 4. ìµœì¢… ì¶”ì²œ: ë‹¨ê³„ë³„ í•˜ì´ë¸Œë¦¬ë“œ ì ‘ê·¼ë²•

### 4.1 1ë‹¨ê³„: ìˆœìˆ˜ ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ë²• (ìš°ì„  êµ¬í˜„)

**ì´ìœ :**
- **100% ì •í™•ì„± ë³´ì¥**: ë°ì´í„°ë² ì´ìŠ¤ì˜ ì •í™•í•œ ë°ì´í„°ë§Œ ì‚¬ìš©
- **ë¹ ë¥¸ êµ¬í˜„**: ê¸°ì¡´ ìŠ¤í‚¤ë§ˆ í™œìš© ê°€ëŠ¥
- **ì‹¤ì‹œê°„ ë¶„ì„**: ì¿¼ë¦¬ ê¸°ë°˜ìœ¼ë¡œ ì¦‰ì‹œ ê²°ê³¼ ì œê³µ
- **ì˜¤ë¥˜ ìµœì†Œí™”**: ë³µì¡í•œ AI ë¡œì§ ì—†ì´ ë‹¨ìˆœí•œ ë¹„êµ ì—°ì‚°

**í•µì‹¬ êµ¬í˜„ ë¡œì§:**
```sql
-- ìƒí’ˆë³„ ìµœì €ê°€ ì¡°íšŒ ì¿¼ë¦¬ ì˜ˆì‹œ
WITH product_prices AS (
  SELECT 
    jsonb_array_elements(mdi.products)->>'name' as product_name,
    CAST(regexp_replace(jsonb_array_elements(mdi.products)->>'price', '[^0-9]', '', 'g') AS INTEGER) as price,
    m.name as mart_name,
    mdi.discount_date,
    ROW_NUMBER() OVER (
      PARTITION BY jsonb_array_elements(mdi.products)->>'name' 
      ORDER BY CAST(regexp_replace(jsonb_array_elements(mdi.products)->>'price', '[^0-9]', '', 'g') AS INTEGER)
    ) as rn
  FROM mart_discount_items mdi
  JOIN mart_discounts md ON mdi.discount_id = md.id
  JOIN marts m ON md.mart_id = m.id
  WHERE mdi.products IS NOT NULL
)
SELECT product_name, price, mart_name, discount_date
FROM product_prices 
WHERE rn = 1
ORDER BY product_name;
```

### 4.2 2ë‹¨ê³„: ìƒí’ˆëª… ì •ê·œí™” ì‹œìŠ¤í…œ (ì •í™•ë„ í–¥ìƒ)

**ìƒí’ˆëª… ì •ê·œí™” ê·œì¹™:**
```typescript
function normalizeProductName(name: string): string {
  return name
    .toLowerCase()                    // ì†Œë¬¸ì ë³€í™˜
    .replace(/\s+/g, '')             // ê³µë°± ì œê±°
    .replace(/[()[\]]/g, '')         // ê´„í˜¸ ì œê±°
    .replace(/[0-9]+g|[0-9]+ml/g, '') // ìš©ëŸ‰ ì •ë³´ ì œê±°
    .replace(/í•œëˆ|êµ­ë‚´ì‚°|ìˆ˜ì…ì‚°/g, '') // ë¸Œëœë“œ/ì›ì‚°ì§€ ì œê±°
    .trim();
}
```

### 4.3 3ë‹¨ê³„: ë²¡í„° ê²€ìƒ‰ ë³´ì™„ (ì„ íƒì‚¬í•­)

**ìœ ì‚¬ ìƒí’ˆ ë§¤ì¹­ì„ ìœ„í•œ ë³´ì™„ ì‹œìŠ¤í…œ:**
- ì •í™•í•œ ë§¤ì¹­ì´ ì•ˆ ë˜ëŠ” ê²½ìš°ì—ë§Œ ë²¡í„° ê²€ìƒ‰ í™œìš©
- ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ìƒí’ˆ ë§¤í•‘ ì„¤ì • ê°€ëŠ¥í•œ ê´€ë¦¬ ì¸í„°í˜ì´ìŠ¤ ì œê³µ

## 5. êµ¬ì²´ì  êµ¬í˜„ ë°©ì•ˆ

### 5.1 ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ í™•ì¥

```typescript
// ìƒí’ˆ ì •ê·œí™” í…Œì´ë¸” (ìƒˆë¡œ ì¶”ê°€)
export const productCatalog = pgTable('product_catalog', {
  id: uuid('id').defaultRandom().primaryKey(),
  normalizedName: text('normalized_name').notNull(), // ì •ê·œí™”ëœ ìƒí’ˆëª…
  originalNames: jsonb('original_names'), // ì›ë³¸ ìƒí’ˆëª… ë°°ì—´
  category: text('category'), // ìƒí’ˆ ì¹´í…Œê³ ë¦¬
  brand: text('brand'), // ë¸Œëœë“œ
  unit: text('unit'), // ë‹¨ìœ„ (g, ml, ê°œ ë“±)
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

// ìµœì €ê°€ ë¶„ì„ ê²°ê³¼ ìºì‹œ í…Œì´ë¸” (ìƒˆë¡œ ì¶”ê°€)
export const productBestPrices = pgTable('product_best_prices', {
  id: uuid('id').defaultRandom().primaryKey(),
  productCatalogId: uuid('product_catalog_id').references(() => productCatalog.id),
  martId: uuid('mart_id').references(() => marts.id),
  discountItemId: uuid('discount_item_id').references(() => martDiscountItems.id),
  lowestPrice: text('lowest_price').notNull(),
  discountDate: timestamp('discount_date').notNull(),
  lastUpdated: timestamp('last_updated').defaultNow().notNull(),
});
```

### 5.2 í•µì‹¬ Server Actions

```typescript
// src/actions/product-analysis.ts
'use server';

import { db } from '@/db';
import { marts, martDiscounts, martDiscountItems, productCatalog, productBestPrices } from '@/db/schema';
import { auth } from '@clerk/nextjs/server';
import { eq, sql, desc, asc } from 'drizzle-orm';
import ExcelJS from 'exceljs';

/**
 * ì „ì²´ ìƒí’ˆë³„ ìµœì €ê°€ ë¶„ì„
 */
export async function analyzeLowestPrices() {
  const { userId } = await auth();
  if (!userId) throw new Error('Unauthorized');

  // 1. ëª¨ë“  í• ì¸ ìƒí’ˆ ë°ì´í„° ì¡°íšŒ
  const allDiscountItems = await db
    .select({
      itemId: martDiscountItems.id,
      martId: martDiscounts.martId,
      martName: marts.name,
      discountDate: martDiscountItems.discountDate,
      products: martDiscountItems.products,
    })
    .from(martDiscountItems)
    .innerJoin(martDiscounts, eq(martDiscountItems.discountId, martDiscounts.id))
    .innerJoin(marts, eq(martDiscounts.martId, marts.id))
    .orderBy(asc(martDiscountItems.discountDate));

  // 2. ìƒí’ˆë³„ ìµœì €ê°€ ë¶„ì„
  const productPriceMap = new Map();
  
  for (const item of allDiscountItems) {
    const products = item.products as Array<{name: string, price: string}>;
    
    for (const product of products || []) {
      const normalizedName = normalizeProductName(product.name);
      const price = parsePrice(product.price);
      
      if (!productPriceMap.has(normalizedName) || 
          productPriceMap.get(normalizedName).price > price) {
        productPriceMap.set(normalizedName, {
          productName: product.name,
          normalizedName,
          price,
          martName: item.martName,
          discountDate: item.discountDate,
          martId: item.martId,
          itemId: item.itemId,
        });
      }
    }
  }

  return Array.from(productPriceMap.values());
}

/**
 * ì—‘ì…€ íŒŒì¼ ìƒì„±
 */
export async function generateLowestPriceExcel() {
  const lowestPrices = await analyzeLowestPrices();
  
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet('ìƒí’ˆë³„ ìµœì €ê°€');
  
  // í—¤ë” ì„¤ì •
  worksheet.columns = [
    { header: 'ìƒí’ˆëª…', key: 'productName', width: 30 },
    { header: 'ìµœì €ê°€ê²©', key: 'price', width: 15 },
    { header: 'ë§ˆíŠ¸ëª…', key: 'martName', width: 20 },
    { header: 'í• ì¸ë‚ ì§œ', key: 'discountDate', width: 15 },
  ];
  
  // ë°ì´í„° ì¶”ê°€
  lowestPrices.forEach(item => {
    worksheet.addRow({
      productName: item.productName,
      price: `${item.price.toLocaleString()}ì›`,
      martName: item.martName,
      discountDate: item.discountDate.toLocaleDateString('ko-KR'),
    });
  });
  
  // ìŠ¤íƒ€ì¼ ì ìš©
  worksheet.getRow(1).font = { bold: true };
  worksheet.autoFilter = 'A1:D1';
  
  const buffer = await workbook.xlsx.writeBuffer();
  return buffer;
}

/**
 * ìƒí’ˆëª… ì •ê·œí™” í•¨ìˆ˜
 */
function normalizeProductName(name: string): string {
  return name
    .toLowerCase()
    .replace(/\s+/g, '')
    .replace(/[()[\]]/g, '')
    .trim();
}

/**
 * ê°€ê²© íŒŒì‹± í•¨ìˆ˜
 */
function parsePrice(priceStr: string): number {
  return parseInt(priceStr.replace(/[^0-9]/g, '')) || 0;
}
```

### 5.3 ë²¡í„° ê²€ìƒ‰ ë³´ì™„ ì‹œìŠ¤í…œ (ì„ íƒì‚¬í•­)

```typescript
// src/lib/services/vector-search.ts
import OpenAI from 'openai';
import { db } from '@/db';
import { vectorStore } from '@/db/schema';

export class ProductVectorSearch {
  private openai: OpenAI;

  constructor() {
    this.openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY,
    });
  }

  /**
   * ìƒí’ˆ ì •ë³´ë¥¼ ë²¡í„°ë¡œ ì„ë² ë”©í•˜ì—¬ ì €ì¥
   */
  async embedProductData() {
    const allProducts = await this.getAllUniqueProducts();
    
    for (const product of allProducts) {
      const embedding = await this.createEmbedding(
        `${product.name} ${product.mart} ${product.price}`
      );
      
      await db.insert(vectorStore).values({
        content: JSON.stringify(product),
        metadata: {
          type: 'product',
          productName: product.name,
          martName: product.mart,
          price: product.price,
        },
        embedding: JSON.stringify(embedding),
      });
    }
  }

  /**
   * ìœ ì‚¬ ìƒí’ˆ ê²€ìƒ‰
   */
  async findSimilarProducts(productName: string, limit = 10) {
    const queryEmbedding = await this.createEmbedding(productName);
    
    // PostgreSQLì˜ ë²¡í„° ìœ ì‚¬ë„ ê²€ìƒ‰ ì‚¬ìš©
    const results = await db.execute(sql`
      SELECT content, metadata, 
             1 - (embedding <=> ${JSON.stringify(queryEmbedding)}) as similarity
      FROM vector_store 
      WHERE metadata->>'type' = 'product'
      ORDER BY embedding <=> ${JSON.stringify(queryEmbedding)}
      LIMIT ${limit}
    `);
    
    return results.rows;
  }

  private async createEmbedding(text: string) {
    const response = await this.openai.embeddings.create({
      model: 'text-embedding-3-small',
      input: text,
    });
    
    return response.data[0].embedding;
  }

  private async getAllUniqueProducts() {
    // ê¸°ì¡´ í• ì¸ ìƒí’ˆ ë°ì´í„°ì—ì„œ ëª¨ë“  ìƒí’ˆ ì¶”ì¶œ
    // êµ¬í˜„ ë¡œì§...
  }
}
```

## 6. êµ¬í˜„ ìš°ì„ ìˆœìœ„ ë° ë‹¨ê³„

### Phase 1: ê¸°ë³¸ ìµœì €ê°€ ë¶„ì„ ì‹œìŠ¤í…œ (2-3ì¼)
1. **Server Action êµ¬í˜„**: `analyzeLowestPrices()`
2. **ì—‘ì…€ ìƒì„± ê¸°ëŠ¥**: `generateLowestPriceExcel()`
3. **ê´€ë¦¬ì í˜ì´ì§€**: `/admin/mart/price-analysis`
4. **ê¸°ë³¸ ìƒí’ˆëª… ì •ê·œí™”**

### Phase 2: ì •í™•ë„ í–¥ìƒ (1-2ì¼)
1. **ìƒí’ˆ ì¹´íƒˆë¡œê·¸ í…Œì´ë¸” ì¶”ê°€**
2. **ìƒí’ˆëª… ì •ê·œí™” ê³ ë„í™”**
3. **ìˆ˜ë™ ë§¤í•‘ ê´€ë¦¬ ì¸í„°í˜ì´ìŠ¤**

### Phase 3: ë²¡í„° ê²€ìƒ‰ ë³´ì™„ (ì„ íƒì‚¬í•­, 2-3ì¼)
1. **pgvector í™•ì¥ ì„¤ì¹˜**
2. **OpenAI ì„ë² ë”© ì—°ë™**
3. **ìœ ì‚¬ë„ ê²€ìƒ‰ ì‹œìŠ¤í…œ**

## 7. í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜

```bash
# ì—‘ì…€ ìƒì„±
npm install exceljs

# ë²¡í„° ê²€ìƒ‰ (ì„ íƒì‚¬í•­)
npm install openai
npm install @types/pg

# PostgreSQL ë²¡í„° í™•ì¥ (ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨)
# CREATE EXTENSION vector;
```

## 8. ìµœì¢… ê²°ë¡  ë° ì¶”ì²œì‚¬í•­

### ğŸ¯ **ê°€ì¥ ì •í™•í•˜ê³  ì˜¤ë¥˜ ì—†ëŠ” ë°©ë²•: ë‹¨ê³„ë³„ ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ë²•**

**1ìˆœìœ„ ì¶”ì²œ: ìˆœìˆ˜ ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ë²•**
- âœ… **ì •í™•ì„±**: 100% ë°ì´í„°ë² ì´ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ ì˜¤ë¥˜ ìµœì†Œí™”
- âœ… **ì„±ëŠ¥**: ë¹ ë¥¸ SQL ì¿¼ë¦¬ë¡œ ì‹¤ì‹œê°„ ë¶„ì„
- âœ… **êµ¬í˜„ ìš©ì´ì„±**: ê¸°ì¡´ ìŠ¤í‚¤ë§ˆ í™œìš© ê°€ëŠ¥
- âœ… **ìœ ì§€ë³´ìˆ˜**: ë‹¨ìˆœí•œ ë¡œì§ìœ¼ë¡œ ë””ë²„ê¹… ì‰¬ì›€

**2ìˆœìœ„ ë³´ì™„: ìƒí’ˆëª… ì •ê·œí™”**
- ë™ì¼ ìƒí’ˆì˜ ë‹¤ë¥¸ í‘œê¸°ë²• ì²˜ë¦¬
- ì‚¬ìš©ì ì •ì˜ ë§¤í•‘ í…Œì´ë¸” í™œìš©

**3ìˆœìœ„ ì„ íƒì‚¬í•­: ë²¡í„° ê²€ìƒ‰**
- ê³ ë„í™”ëœ ìœ ì‚¬ ìƒí’ˆ ë§¤ì¹­
- ì¶”ê°€ ë¹„ìš©ê³¼ ë³µì¡ì„± ê³ ë ¤ í•„ìš”

ì´ ë°©ë²•ì„ í†µí•´ **í•œëˆì•”ë¼ì§€ ìƒì‚¼ê²¹ì‚´ 600g â†’ ì€ì„±ë§ˆíŠ¸, 10ì›” 16ì¼, 11,000ì›**ê³¼ ê°™ì€ ì •í™•í•œ ìµœì €ê°€ ì •ë³´ë¥¼ ì˜¤ë¥˜ ì—†ì´ ë„ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
