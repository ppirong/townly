# 🚀 카카오 비즈니스 API 연동 가이드

## 개요

정기 발송 스케줄 시스템이 실제 카카오 비즈니스 API와 연동되었습니다. 이제 실제 카카오톡 채널을 통해 브로드캐스트 메시지와 알림톡을 발송할 수 있습니다.

## 🔧 환경변수 설정

### 필수 환경변수

`.env.local` 파일에 다음 환경변수들을 추가하세요:

```env
# 기존 환경변수들...

# 카카오 비즈니스 API 설정
KAKAO_REST_API_KEY=your_rest_api_key_here
KAKAO_ADMIN_KEY=your_admin_key_here
KAKAO_CHANNEL_ID=your_channel_id_here
KAKAO_SENDER_KEY=your_sender_key_here
KAKAO_TEMPLATE_ID=your_template_id_here

# 크론잡 보안 토큰 (선택적)
CRON_SECRET=your_cron_secret_here
```

### 환경변수 설명

| 변수명 | 설명 | 필수 여부 |
|--------|------|----------|
| `KAKAO_REST_API_KEY` | 카카오 REST API 키 | 선택적 |
| `KAKAO_ADMIN_KEY` | 카카오 비즈니스 관리자 키 | **필수** (없으면 시뮬레이션 모드) |
| `KAKAO_CHANNEL_ID` | 카카오톡 채널 ID | **필수** |
| `KAKAO_SENDER_KEY` | 알림톡 발신자 키 | 알림톡 사용 시 필수 |
| `KAKAO_TEMPLATE_ID` | 기본 알림톡 템플릿 ID | 알림톡 사용 시 필수 |

## 📋 카카오 비즈니스 API 설정 절차

### 1단계: 카카오 비즈니스 계정 생성

1. **카카오 비즈니스** (https://business.kakao.com/) 접속
2. 계정 생성 및 사업자 인증 완료
3. 카카오톡 채널 연결

### 2단계: API 키 발급

1. **카카오 개발자센터** (https://developers.kakao.com/) 접속
2. 애플리케이션 생성
3. **REST API 키** 복사
4. **Admin 키** 발급 (비즈니스 인증 필요)

### 3단계: 알림톡 템플릿 등록 (선택적)

1. **카카오 비즈니스 관리자센터** 접속
2. **알림톡 > 템플릿 관리** 메뉴
3. 새 템플릿 등록 및 승인 요청
4. 승인 완료 후 **템플릿 ID** 확인

### 4단계: 월렛 충전

1. **카카오 비즈니스 관리자센터** 접속
2. **결제 > 월렛 충전** 메뉴
3. 원하는 금액 충전 (최소 10,000원 권장)

## 💰 요금 체계

### 메시지 발송 비용

| 메시지 유형 | 단가 | 설명 |
|------------|------|------|
| **브로드캐스트** | 15원/건 | 채널 구독자 전체 발송 |
| **알림톡** | 8원/건 | 개인화된 메시지 발송 |

### 월렛 관리

- **최소 충전 금액**: 10,000원
- **권장 잔액**: 50,000원 이상
- **자동 충전**: 설정 가능 (잔액 부족 시)

## 🔄 동작 모드

### 시뮬레이션 모드 (기본)

- **조건**: `KAKAO_ADMIN_KEY`가 설정되지 않음
- **동작**: 실제 발송 없이 로그만 출력
- **비용**: 무료
- **용도**: 개발 및 테스트

### 프로덕션 모드

- **조건**: `KAKAO_ADMIN_KEY`가 설정됨
- **동작**: 실제 카카오 API 호출
- **비용**: 실제 요금 부과
- **용도**: 실서비스

## 🧪 테스트 방법

### 1. API 상태 확인

```bash
curl http://localhost:3000/api/kakao/send-message
```

### 2. 월렛 잔액 확인

```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
     http://localhost:3000/api/kakao/wallet
```

### 3. 테스트 메시지 발송

```bash
curl -X POST http://localhost:3000/api/kakao/send-message \
     -H "Content-Type: application/json" \
     -d '{
       "message": "테스트 메시지입니다",
       "messageType": "text"
     }'
```

### 4. 발송 가능 여부 확인

```bash
curl -X POST http://localhost:3000/api/kakao/wallet \
     -H "Content-Type: application/json" \
     -d '{
       "messageType": "broadcast",
       "recipientCount": 1
     }'
```

## 📊 모니터링 및 관리

### 대시보드 접근

1. **월렛 상태**: `/api/kakao/wallet`
2. **정기 발송 관리**: `/admin/scheduled-messages`
3. **메시지 로그**: `/admin/kakao`

### 로그 확인

- **서버 로그**: 콘솔에서 실시간 확인
- **발송 로그**: 데이터베이스 `scheduled_message_logs` 테이블
- **월렛 로그**: API 응답에서 확인

## ⚠️ 주의사항

### 보안

1. **API 키 보안**: `.env.local` 파일을 버전 관리에 포함하지 마세요
2. **인증 확인**: 모든 API는 Clerk 인증이 필요합니다
3. **권한 관리**: 관리자만 메시지 발송 가능

### 비용 관리

1. **월렛 모니터링**: 정기적으로 잔액 확인
2. **발송량 제한**: 무분별한 발송 방지
3. **테스트 환경**: 시뮬레이션 모드 활용

### 법적 준수

1. **개인정보보호법**: 사용자 동의 없는 마케팅 발송 금지
2. **정보통신망법**: 광고성 정보 발송 시 표시 의무
3. **카카오 정책**: 카카오톡 채널 운영 정책 준수

## 🛠️ 문제 해결

### 자주 발생하는 오류

#### 1. API 키 오류

```
Error: 카카오 비즈니스 API 키가 설정되지 않았습니다.
```

**해결방법**: `.env.local`에 `KAKAO_ADMIN_KEY` 추가

#### 2. 월렛 잔액 부족

```
Error: 월렛 잔액이 부족합니다. 충전 후 다시 시도해주세요.
```

**해결방법**: 카카오 비즈니스 관리자센터에서 월렛 충전

#### 3. 템플릿 없음 오류

```
Error: 알림톡 발송 시 templateId가 필요합니다.
```

**해결방법**: 템플릿 등록 후 `KAKAO_TEMPLATE_ID` 설정

### 디버깅 가이드

1. **로그 확인**: 서버 콘솔에서 상세 로그 확인
2. **API 응답**: 응답 JSON에서 오류 메시지 확인
3. **환경변수**: `/api/health`에서 설정 상태 확인

## 🚀 업그레이드 로드맵

### 단기 계획

1. **템플릿 관리**: 웹 인터페이스에서 템플릿 관리
2. **통계 대시보드**: 발송 통계 및 비용 분석
3. **자동 충전**: 잔액 부족 시 자동 충전

### 장기 계획

1. **AI 최적화**: 발송 시간 최적화
2. **A/B 테스트**: 메시지 효과 분석
3. **다중 채널**: 여러 카카오 채널 관리

## 📞 지원

- **기술 문의**: 개발팀
- **카카오 API 문의**: 카카오 비즈니스 고객센터
- **결제 문의**: 카카오페이 고객센터

---

**✅ 설정 완료 체크리스트**

- [ ] 카카오 비즈니스 계정 생성
- [ ] API 키 발급 및 설정
- [ ] 월렛 충전 완료
- [ ] 환경변수 설정 완료
- [ ] 테스트 발송 성공
- [ ] 모니터링 시스템 확인

설정이 완료되면 정기 발송 스케줄 시스템이 실제 카카오톡 채널을 통해 메시지를 발송합니다! 🎉
